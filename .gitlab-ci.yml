# Simple CI - Linux build only (uses GitLab free runners)
stages:
  - build

variables:
  GIT_SUBMODULE_STRATEGY: recursive

build-linux:
  stage: build
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y git build-essential qtbase5-dev qt5-qmake qtbase5-dev-tools libusb-1.0-0-dev libhidapi-dev
  script:
    - qmake OpenRGB3DSpatialPlugin.pro PREFIX=/usr
    - make -j$(nproc)
  artifacts:
    name: "OpenRGB3DSpatialPlugin-Linux-$CI_COMMIT_SHORT_SHA"
    paths:
      - libOpenRGB3DSpatialPlugin.so
    expire_in: 30 days
  only:
    - master
    - tags


build-windows:
  stage: build
  tags:
    - windows
  variables:
    QT_BIN_PATH: 'C:\Qt\5.15.0\msvc2019_64\bin'
    VC_VARS_BAT: 'C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat'
  script:
    - |
      cmd /C "\"%VC_VARS_BAT%\" && \"%QT_BIN_PATH%\qmake.exe\" OpenRGB3DSpatialPlugin.pro CONFIG+=release && nmake"
  artifacts:
    name: "OpenRGB3DSpatialPlugin-Windows-$CI_COMMIT_SHORT_SHA"
    paths:
      - release\OpenRGB3DSpatialPlugin.dll
    expire_in: 30 days
  only:
    - master
    - tags
