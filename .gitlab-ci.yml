#-----------------------------------------------------------#
# .gitlab-ci.yml                                            #
#                                                           #
#   OpenRGB3DSpatialPlugin GitLab CI Configuration         #
#                                                           #
#   This file is part of the OpenRGB3DSpatialPlugin        #
#   SPDX-License-Identifier: GPL-2.0-only                 #
#-----------------------------------------------------------#

stages:
  - sync
  - build
  - release

variables:
  GIT_DEPTH: 0

#-----------------------------------------------------------#
# Sync to GitHub (mirror code and tags)                    #
#-----------------------------------------------------------#
sync-to-github:
  stage: sync
  image: alpine/git:latest
  before_script:
    - apk add --no-cache git
  script:
    - |
      # Skip if GITHUB_TOKEN is not set
      if [ -z "$GITHUB_TOKEN" ]; then
        echo "GITHUB_TOKEN not set, skipping GitHub sync"
        exit 0
      fi
      
      # Configure git
      git config user.name "GitLab CI"
      git config user.email "gitlab-ci@gitlab.com"
      
      # Add GitHub remote
      git remote add github https://${GITHUB_TOKEN}@github.com/Wolfieeewolf/OpenRGB3DSpatialPlugin.git 2>/dev/null || \
      git remote set-url github https://${GITHUB_TOKEN}@github.com/Wolfieeewolf/OpenRGB3DSpatialPlugin.git
      
      # Fetch all refs from GitHub
      git fetch github --prune
      
      # Push branch to GitHub
      if [ "$CI_COMMIT_REF_NAME" = "master" ]; then
        git push github HEAD:master --force || echo "GitHub branch push failed"
      fi
      
      # Push all tags to GitHub
      git push github --tags --force || echo "GitHub tag push failed"
  only:
    - master
    - tags
  when: on_success

#-----------------------------------------------------------#
# Windows Build                                             #
#-----------------------------------------------------------#
build-windows:
  stage: build
  tags:
    - windows
    - shared-windows
  before_script:
    - echo "Building on Windows runner"
  script:
    - call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
    - qmake OpenRGB3DSpatialPlugin.pro CONFIG+=release
    - nmake
  artifacts:
    paths:
      - release/OpenRGB3DSpatialPlugin.dll
    expire_in: 30 days
  only:
    - master
    - tags
    - merge_requests

#-----------------------------------------------------------#
# Linux Build                                               #
#-----------------------------------------------------------#
build-linux:
  stage: build
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq qtbase5-dev qt5-qmake qtbase5-dev-tools libusb-1.0-0-dev libhidapi-dev build-essential
  script:
    - qmake OpenRGB3DSpatialPlugin.pro PREFIX=/usr
    - make -j$(nproc)
  artifacts:
    paths:
      - libOpenRGB3DSpatialPlugin.so
    expire_in: 30 days
  only:
    - master
    - tags
    - merge_requests

#-----------------------------------------------------------#
# Release (creates GitLab release with artifacts)          #
#-----------------------------------------------------------#
release:
  stage: release
  image: curlimages/curl:latest
  dependencies:
    - build-windows
    - build-linux
  needs:
    - job: build-windows
      artifacts: true
    - job: build-linux
      artifacts: true
  variables:
    GITHUB_TOKEN: $GITHUB_TOKEN
  script:
    - |
      # Check for artifacts from build jobs
      echo "Checking for build artifacts..."
      if [ -f "release/OpenRGB3DSpatialPlugin.dll" ]; then
        echo "✓ Windows DLL artifact found from GitLab build"
      else
        echo "⚠ Warning: Windows DLL artifact not found from GitLab build"
        # Try to download from GitHub Actions if available
        if [ ! -z "$GITHUB_TOKEN" ]; then
          echo "Attempting to download Windows DLL from GitHub Actions..."
          PACKAGE_VERSION=$(git rev-parse --short HEAD)
          curl -s --header "PRIVATE-TOKEN: ${GITHUB_TOKEN}" \
            --output "release/OpenRGB3DSpatialPlugin.dll" \
            "https://gitlab.com/api/v4/projects/wolfieeewolf1%2FOpenRGB3DSpatialPlugin/packages/generic/build-artifacts/${PACKAGE_VERSION}/OpenRGB3DSpatialPlugin.dll" || echo "Could not download from GitLab packages"
        fi
      fi
      
      if [ -f "libOpenRGB3DSpatialPlugin.so" ]; then
        echo "✓ Linux SO artifact found from GitLab build"
      else
        echo "⚠ Warning: Linux SO artifact not found from GitLab build"
        # Try to download from GitHub Actions if available
        if [ ! -z "$GITHUB_TOKEN" ]; then
          echo "Attempting to download Linux SO from GitHub Actions..."
          PACKAGE_VERSION=$(git rev-parse --short HEAD)
          curl -s --header "PRIVATE-TOKEN: ${GITHUB_TOKEN}" \
            --output "libOpenRGB3DSpatialPlugin.so" \
            "https://gitlab.com/api/v4/projects/wolfieeewolf1%2FOpenRGB3DSpatialPlugin/packages/generic/build-artifacts/${PACKAGE_VERSION}/libOpenRGB3DSpatialPlugin.so" || echo "Could not download from GitLab packages"
        fi
      fi
    - |
      VERSION=${CI_COMMIT_TAG#v}
      if [ -z "$VERSION" ]; then
        VERSION=${CI_COMMIT_REF_NAME#v}
      fi
      
      echo "Creating release for version: $CI_COMMIT_TAG"
      
      # Create release on GitLab
      curl --request POST \
        --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
        --header "Content-Type: application/json" \
        --data "{\"tag_name\":\"${CI_COMMIT_TAG}\",\"name\":\"${CI_COMMIT_TAG}\",\"description\":\"Release ${CI_COMMIT_TAG} - Built on GitLab CI\"}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases" || echo "Release creation failed"
      
      # Upload Windows DLL if it exists
      if [ -f "release/OpenRGB3DSpatialPlugin.dll" ]; then
        echo "Uploading Windows DLL..."
        UPLOAD_RESPONSE=$(curl -s --request POST \
          --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
          --form "file=@release/OpenRGB3DSpatialPlugin.dll" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/uploads" || echo "{}")
        
        UPLOAD_URL=$(echo "$UPLOAD_RESPONSE" | grep -o '"url":"[^"]*"' | cut -d'"' -f4 || echo "")
        if [ ! -z "$UPLOAD_URL" ] && [ "$UPLOAD_URL" != "null" ]; then
          curl -s --request POST \
            --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "{\"name\":\"Windows DLL\",\"url\":\"${CI_PROJECT_URL}${UPLOAD_URL}\"}" \
            "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/${CI_COMMIT_TAG}/assets/links" || echo "Failed to link Windows DLL"
        fi
      fi
      
      # Upload Linux SO if it exists
      if [ -f "libOpenRGB3DSpatialPlugin.so" ]; then
        echo "Uploading Linux SO..."
        UPLOAD_RESPONSE=$(curl -s --request POST \
          --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
          --form "file=@libOpenRGB3DSpatialPlugin.so" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/uploads" || echo "{}")
        
        UPLOAD_URL=$(echo "$UPLOAD_RESPONSE" | grep -o '"url":"[^"]*"' | cut -d'"' -f4 || echo "")
        if [ ! -z "$UPLOAD_URL" ] && [ "$UPLOAD_URL" != "null" ]; then
          curl -s --request POST \
            --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "{\"name\":\"Linux SO\",\"url\":\"${CI_PROJECT_URL}${UPLOAD_URL}\"}" \
            "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/${CI_COMMIT_TAG}/assets/links" || echo "Failed to link Linux SO"
        fi
      fi
      
      # Create GitHub release if GITHUB_TOKEN is set
      if [ ! -z "$GITHUB_TOKEN" ]; then
        echo "Creating GitHub release for version: $CI_COMMIT_TAG"
        
        # Download artifacts from build jobs
        if [ -f "release/OpenRGB3DSpatialPlugin.dll" ]; then
          DLL_FILE="release/OpenRGB3DSpatialPlugin.dll"
        else
          DLL_FILE=""
        fi
        
        if [ -f "libOpenRGB3DSpatialPlugin.so" ]; then
          SO_FILE="libOpenRGB3DSpatialPlugin.so"
        else
          SO_FILE=""
        fi
        
        # Create release using GitHub API
        RELEASE_RESPONSE=$(curl -s --request POST \
          --header "Authorization: token ${GITHUB_TOKEN}" \
          --header "Accept: application/vnd.github.v3+json" \
          --data "{\"tag_name\":\"${CI_COMMIT_TAG}\",\"name\":\"${CI_COMMIT_TAG}\",\"body\":\"Release ${CI_COMMIT_TAG} - Built on GitLab CI\"}" \
          "https://api.github.com/repos/Wolfieeewolf/OpenRGB3DSpatialPlugin/releases" || echo "{}")
        
        UPLOAD_URL=$(echo "$RELEASE_RESPONSE" | grep -o '"upload_url":"[^"]*"' | cut -d'"' -f4 | sed 's/{?name,label}//' || echo "")
        
        if [ ! -z "$UPLOAD_URL" ] && [ "$UPLOAD_URL" != "null" ]; then
          # Upload Windows DLL
          if [ ! -z "$DLL_FILE" ] && [ -f "$DLL_FILE" ]; then
            echo "Uploading Windows DLL to GitHub..."
            curl -s --request POST \
              --header "Authorization: token ${GITHUB_TOKEN}" \
              --header "Content-Type: application/octet-stream" \
              --data-binary "@${DLL_FILE}" \
              "${UPLOAD_URL}?name=OpenRGB3DSpatialPlugin.dll" || echo "Failed to upload DLL to GitHub"
          fi
          
          # Upload Linux SO
          if [ ! -z "$SO_FILE" ] && [ -f "$SO_FILE" ]; then
            echo "Uploading Linux SO to GitHub..."
            curl -s --request POST \
              --header "Authorization: token ${GITHUB_TOKEN}" \
              --header "Content-Type: application/octet-stream" \
              --data-binary "@${SO_FILE}" \
              "${UPLOAD_URL}?name=libOpenRGB3DSpatialPlugin.so" || echo "Failed to upload SO to GitHub"
          fi
        fi
      else
        echo "GITHUB_TOKEN not set, skipping GitHub release creation"
      fi
  only:
    - tags
  when: on_success
