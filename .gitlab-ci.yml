#-----------------------------------------------------------#
# .gitlab-ci.yml                                            #
#                                                           #
#   OpenRGB3DSpatialPlugin GitLab CI Configuration         #
#                                                           #
#   This file is part of the OpenRGB3DSpatialPlugin        #
#   SPDX-License-Identifier: GPL-2.0-only                 #
#-----------------------------------------------------------#

stages:
  - build
  - release

variables:
  GIT_DEPTH: 0

#-----------------------------------------------------------#
# Windows Build                                             #
#-----------------------------------------------------------#
build-windows:
  stage: build
  tags:
    - windows
    - shared-windows
  before_script:
    - echo "Building on Windows runner"
  script:
    - call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
    - qmake OpenRGB3DSpatialPlugin.pro CONFIG+=release
    - nmake
  artifacts:
    paths:
      - release/OpenRGB3DSpatialPlugin.dll
    expire_in: 30 days
  only:
    - master
    - tags
    - merge_requests

#-----------------------------------------------------------#
# Linux Build                                               #
#-----------------------------------------------------------#
build-linux:
  stage: build
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq qtbase5-dev qt5-qmake qtbase5-dev-tools libusb-1.0-0-dev libhidapi-dev build-essential
  script:
    - qmake OpenRGB3DSpatialPlugin.pro PREFIX=/usr
    - make -j$(nproc)
  artifacts:
    paths:
      - libOpenRGB3DSpatialPlugin.so
    expire_in: 30 days
  only:
    - master
    - tags
    - merge_requests

#-----------------------------------------------------------#
# Release (creates GitLab release with artifacts)          #
#-----------------------------------------------------------#
release:
  stage: release
  image: curlimages/curl:latest
  dependencies:
    - build-windows
    - build-linux
  script:
    - |
      VERSION=${CI_COMMIT_TAG#v}
      if [ -z "$VERSION" ]; then
        VERSION=${CI_COMMIT_REF_NAME#v}
      fi
      
      echo "Creating release for version: $CI_COMMIT_TAG"
      
      # Create release on GitLab
      curl --request POST \
        --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
        --header "Content-Type: application/json" \
        --data "{\"tag_name\":\"${CI_COMMIT_TAG}\",\"name\":\"${CI_COMMIT_TAG}\",\"description\":\"Release ${CI_COMMIT_TAG} - Built on GitLab CI\"}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases" || echo "Release creation failed"
      
      # Upload Windows DLL if it exists
      if [ -f "release/OpenRGB3DSpatialPlugin.dll" ]; then
        echo "Uploading Windows DLL..."
        UPLOAD_RESPONSE=$(curl -s --request POST \
          --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
          --form "file=@release/OpenRGB3DSpatialPlugin.dll" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/uploads" || echo "{}")
        
        UPLOAD_URL=$(echo "$UPLOAD_RESPONSE" | grep -o '"url":"[^"]*"' | cut -d'"' -f4 || echo "")
        if [ ! -z "$UPLOAD_URL" ] && [ "$UPLOAD_URL" != "null" ]; then
          curl -s --request POST \
            --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "{\"name\":\"Windows DLL\",\"url\":\"${CI_PROJECT_URL}${UPLOAD_URL}\"}" \
            "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/${CI_COMMIT_TAG}/assets/links" || echo "Failed to link Windows DLL"
        fi
      fi
      
      # Upload Linux SO if it exists
      if [ -f "libOpenRGB3DSpatialPlugin.so" ]; then
        echo "Uploading Linux SO..."
        UPLOAD_RESPONSE=$(curl -s --request POST \
          --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
          --form "file=@libOpenRGB3DSpatialPlugin.so" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/uploads" || echo "{}")
        
        UPLOAD_URL=$(echo "$UPLOAD_RESPONSE" | grep -o '"url":"[^"]*"' | cut -d'"' -f4 || echo "")
        if [ ! -z "$UPLOAD_URL" ] && [ "$UPLOAD_URL" != "null" ]; then
          curl -s --request POST \
            --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "{\"name\":\"Linux SO\",\"url\":\"${CI_PROJECT_URL}${UPLOAD_URL}\"}" \
            "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/${CI_COMMIT_TAG}/assets/links" || echo "Failed to link Linux SO"
        fi
      fi
  only:
    - tags
  when: on_success
